"use strict";(self.webpackChunkem_guide_app=self.webpackChunkem_guide_app||[]).push([[9226],{99226:(us,K,s)=>{s.r(K),s.d(K,{default:()=>is});var e=s(56940),E=s(30956),i=s(93484),j=s(63355),c=s(75937),G=s(58400),T=s(66041),J=s(39738),A=s(74065),Q=s(30454),I=s(24926),X=s(21709),b=s(48288),q=s(40829),ss=s(82018),es=s(98305),ts=s(62128),o=s(45846),os=s(74089),O=s(3878),f=s(86857),r=s(50086),ns=s(63037),Cs=s(21633),Ls=s(85845),ws=s(88720),Ts=s(66086),As=s(88193),Is=s(8232),Rs=s(5337),Ws=s(4357),ps=s(41480),ys=s(32635),Bs=s(42052),Us=s(67620),Ks=s(71999),js=s(4549),Ss=s(333),xs=s(78712),ks=s(27469),Fs=s(41062),Ns=s(49079),Zs=s(1205),zs=s(30913),Vs=s(95721),Ys=s(76769),Hs=s(45641),$s=s(30120);function as(){const{workflowId:v}=(0,ss.UO)(),rs=(0,i.useSelector)(j.s),{formatMessage:n}=(0,b.Z)(),g=(0,i.useDispatch)(),{put:ls}=(0,E.useFetchClient)(),{formatAPIError:_s}=(0,E.useAPIErrorHandler)(),h=(0,E.useNotification)(),{isLoading:m,meta:u,workflows:C,refetch:ds}=(0,ns.u)(),{collectionTypes:S,singleTypes:x,isLoading:R}=(0,ts.u)(),Es=(0,i.useSelector)(o.j),gs=(0,i.useSelector)(o.a),l=(0,i.useSelector)(o.b),k=(0,i.useSelector)(o.k),F=(0,i.useSelector)(o.c),D=(0,i.useSelector)(o.s),{allowedActions:{canDelete:cs,canUpdate:W}}=(0,E.useRBAC)(rs.settings["review-workflows"]),[L,w]=c.useState({}),{getFeature:fs,isLoading:N}=(0,os.u)(),{isLoading:p,roles:Z}=(0,es.u)(void 0,{retry:!1}),[z,M]=c.useState(!1),[Ms,V]=c.useState(null),Y=C.find(t=>t.id===parseInt(v,10)),H=C.filter(t=>t.id!==parseInt(v,10)).flatMap(t=>t.contentTypes),{mutateAsync:ms,isLoading:Ds}=(0,q.useMutation)(async({workflow:t})=>{const{data:{data:a}}=await ls(`/admin/review-workflows/workflows/${t.id}`,{data:t});return a},{onSuccess(){h({type:"success",message:{id:"notification.success.saved",defaultMessage:"Saved"}})}}),Ps=async t=>{V(null);try{return await ms({workflow:{...t,stages:t.stages.map(d=>{let P=!0;const B=Es.workflow.stages.find(U=>U.id===d?.id);return B&&(P=B.permissions?.length!==d.permission?.length||!B.permissions.every(U=>!!d.permissions.find(hs=>hs.role===U.role))),{...d,permissions:P?d.permissions:void 0}})}})}catch(a){return a.response.data?.error?.name==="ValidationError"&&a.response.data?.error?.details?.errors?.length>0&&V(a.response.data?.error?.details?.errors.reduce((d,P)=>(X(d,P.path,P.message),d),{})),h({type:"warning",message:_s(a)}),null}},$=async()=>{await Ps(l),await ds(),w({})},Os=async()=>{await $()},vs=()=>{w({})},y=(0,I.useFormik)({enableReinitialize:!0,initialErrors:Ms,initialValues:l,async onSubmit(){const t=l.contentTypes.some(a=>H.includes(a));_?.[r.C]&&u?.workflowCount>parseInt(_[r.C],10)?M("workflow"):_?.[r.a]&&l.stages.length>parseInt(_[r.a],10)?M("stage"):k||t?(k&&w(a=>({...a,hasDeletedServerStages:!0})),t&&w(a=>({...a,hasReassignedContentTypes:!0}))):$()},validate(t){return(0,o.v)({values:t,formatMessage:n})}});(0,o.u)(r.R,o.i);const _=fs("review-workflows");return c.useEffect(()=>(m||(g((0,o.l)({workflow:Y})),g((0,o.d)({workflows:C}))),R||g((0,o.e)({collectionTypes:S,singleTypes:x})),p||g((0,o.f)(Z)),g((0,o.g)(m||R||p)),()=>{g((0,o.r)())}),[S,g,R,m,p,Z,x,Y,C]),c.useEffect(()=>{!m&&!N&&(_?.[r.C]&&u?.workflowCount>parseInt(_[r.C],10)?M("workflow"):_?.[r.a]&&l.stages.length>parseInt(_[r.a],10)&&M("stage"))},[l.stages.length,N,m,_,u?.workflowCount,u.workflowsTotal]),c.useEffect(()=>{!D&&F.length===0&&h({blockTransition:!0,type:"warning",message:n({id:"Settings.review-workflows.stage.permissions.noPermissions.description",defaultMessage:"You don\u2019t have the permission to see roles"})})},[n,D,F,h]),(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(O.D,{}),(0,e.jsx)(I.FormikProvider,{value:y,children:(0,e.jsxs)(I.Form,{onSubmit:y.handleSubmit,children:[(0,e.jsx)(O.H,{navigationAction:(0,e.jsx)(O.B,{href:"/settings/review-workflows"}),primaryAction:W&&(0,e.jsx)(G.z,{startIcon:(0,e.jsx)(Q.Z,{}),type:"submit",size:"M",disabled:!gs,loading:!Object.keys(L).length>0&&Ds,children:n({id:"global.save",defaultMessage:"Save"})}),subtitle:!D&&n({id:"Settings.review-workflows.page.subtitle",defaultMessage:"{count, plural, one {# stage} other {# stages}}"},{count:l.stages.length}),title:l.name}),(0,e.jsx)(O.R,{children:D?(0,e.jsx)(T.k,{justifyContent:"center",children:(0,e.jsx)(J.a,{children:n({id:"Settings.review-workflows.page.isLoading",defaultMessage:"Workflow is loading"})})}):(0,e.jsxs)(T.k,{alignItems:"stretch",direction:"column",gap:7,children:[(0,e.jsx)(o.W,{canUpdate:W}),(0,e.jsx)(o.S,{canDelete:cs,canUpdate:W,stages:y.values?.stages})]})})]})}),(0,e.jsx)(E.ConfirmDialog.Root,{isConfirmButtonLoading:D,isOpen:Object.keys(L).length>0,onToggleDialog:vs,onConfirm:Os,children:(0,e.jsx)(E.ConfirmDialog.Body,{children:(0,e.jsxs)(T.k,{direction:"column",gap:5,children:[L.hasDeletedServerStages&&(0,e.jsx)(A.Z,{textAlign:"center",variant:"omega",children:n({id:"Settings.review-workflows.page.delete.confirm.stages.body",defaultMessage:"All entries assigned to deleted stages will be moved to the previous stage."})}),L.hasReassignedContentTypes&&(0,e.jsx)(A.Z,{textAlign:"center",variant:"omega",children:n({id:"Settings.review-workflows.page.delete.confirm.contentType.body",defaultMessage:"{count} {count, plural, one {content-type} other {content-types}} {count, plural, one {is} other {are}} already mapped to {count, plural, one {another workflow} other {other workflows}}. If you save changes, {count, plural, one {this} other {these}} {count, plural, one {content-type} other {{count} content-types}} will no more be mapped to the {count, plural, one {another workflow} other {other workflows}} and all corresponding information will be removed."},{count:H.filter(t=>l.contentTypes.includes(t)).length})}),(0,e.jsx)(A.Z,{textAlign:"center",variant:"omega",children:n({id:"Settings.review-workflows.page.delete.confirm.confirm",defaultMessage:"Are you sure you want to save?"})})]})})}),(0,e.jsxs)(f.L,{isOpen:z==="workflow",onClose:()=>M(!1),children:[(0,e.jsx)(f.T,{children:n({id:"Settings.review-workflows.edit.page.workflows.limit.title",defaultMessage:"You\u2019ve reached the limit of workflows in your plan"})}),(0,e.jsx)(f.B,{children:n({id:"Settings.review-workflows.edit.page.workflows.limit.body",defaultMessage:"Delete a workflow or contact Sales to enable more workflows."})})]}),(0,e.jsxs)(f.L,{isOpen:z==="stage",onClose:()=>M(!1),children:[(0,e.jsx)(f.T,{children:n({id:"Settings.review-workflows.edit.page.stages.limit.title",defaultMessage:"You have reached the limit of stages for this workflow in your plan"})}),(0,e.jsx)(f.B,{children:n({id:"Settings.review-workflows.edit.page.stages.limit.body",defaultMessage:"Try deleting some stages or contact Sales to enable more stages."})})]})]})}function is(){const v=(0,i.useSelector)(j.s);return(0,e.jsx)(E.CheckPagePermissions,{permissions:v.settings["review-workflows"].main,children:(0,e.jsx)(as,{})})}}}]);
