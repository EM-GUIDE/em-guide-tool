"use strict";(self.webpackChunkem_guide_app=self.webpackChunkem_guide_app||[]).push([[1140],{21140:(Es,R,s)=>{s.r(R),s.d(R,{default:()=>b});var e=s(56940),E=s(30956),d=s(93484),k=s(63355),g=s(75937),F=s(58400),O=s(66041),N=s(39738),I=s(74065),Z=s(30454),h=s(24926),z=s(21709),V=s(48288),Y=s(40829),H=s(82018),$=s(98305),G=s(62128),o=s(45846),J=s(74089),M=s(3878),c=s(86857),a=s(50086),Q=s(63037),ds=s(21633),gs=s(85845),cs=s(88720),fs=s(66086),Ms=s(88193),Ds=s(8232),Ps=s(5337),ms=s(4357),Os=s(41480),hs=s(32635),vs=s(42052),us=s(67620),Cs=s(71999),Ls=s(4549),Ts=s(333),ws=s(78712),Rs=s(27469),Is=s(41062),As=s(49079),Ws=s(1205),Bs=s(30913),ys=s(95721),Ks=s(76769),Us=s(45641),ps=s(30120);function X(){const{formatMessage:n}=(0,V.Z)(),{post:q}=(0,E.useFetchClient)(),{push:ss}=(0,H.k6)(),{formatAPIError:es}=(0,E.useAPIErrorHandler)(),_=(0,d.useDispatch)(),D=(0,E.useNotification)(),{collectionTypes:A,singleTypes:W,isLoading:v}=(0,G.u)(),{isLoading:P,meta:u,workflows:C}=(0,Q.u)(),{isLoading:L,roles:B}=(0,$.u)(void 0,{retry:!1}),m=(0,d.useSelector)(o.s),ts=(0,d.useSelector)(o.a),l=(0,d.useSelector)(o.b),y=(0,d.useSelector)(o.c),[K,f]=g.useState(!1),{isLoading:U,getFeature:os}=(0,J.u)(),[ns,as]=g.useState(null),[p,T]=g.useState({}),i=os("review-workflows"),j=C.flatMap(t=>t.contentTypes),{mutateAsync:is,isLoading:ls}=(0,Y.useMutation)(async({workflow:t})=>{const{data:{data:r}}=await q("/admin/review-workflows/workflows",{data:t});return r},{onSuccess(){D({type:"success",message:{id:"Settings.review-workflows.create.page.notification.success",defaultMessage:"Workflow successfully created"}})}}),x=async()=>{T({});try{const t=await is({workflow:l});return ss(`/settings/review-workflows/${t.id}`),t}catch(t){return t.response.data?.error?.name==="ValidationError"&&t.response.data?.error?.details?.errors?.length>0&&as(t.response.data?.error?.details?.errors.reduce((r,S)=>(z(r,S.path,S.message),r),{})),D({type:"warning",message:es(t)}),null}},rs=async()=>{await x()},_s=()=>{T({})},w=(0,h.useFormik)({enableReinitialize:!0,initialErrors:ns,initialValues:l,async onSubmit(){const t=l.contentTypes.some(r=>j.includes(r));i?.[a.C]&&u?.workflowCount>=parseInt(i[a.C],10)?f("workflow"):i?.[a.a]&&l.stages.length>=parseInt(i[a.a],10)?f("stage"):t?T(r=>({...r,hasReassignedContentTypes:!0})):x()},validate(t){return(0,o.v)({values:t,formatMessage:n})}});return(0,o.u)(a.R,o.i),g.useEffect(()=>{_((0,o.r)()),P||_((0,o.d)({workflows:C})),v||_((0,o.e)({collectionTypes:A,singleTypes:W})),L||_((0,o.f)(B)),_((0,o.g)(v||L)),_((0,o.h)({name:""}))},[A,_,v,L,P,B,W,C]),g.useEffect(()=>{!P&&!U&&(i?.[a.C]&&u?.workflowsTotal>=parseInt(i[a.C],10)?f("workflow"):i?.[a.a]&&l.stages.length>=parseInt(i[a.a],10)&&f("stage"))},[U,P,i,u?.workflowsTotal,l.stages.length]),g.useEffect(()=>{!m&&y.length===0&&D({blockTransition:!0,type:"warning",message:n({id:"Settings.review-workflows.stage.permissions.noPermissions.description",defaultMessage:"You don\u2019t have the permission to see roles"})})},[n,m,y,D]),(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(M.D,{}),(0,e.jsx)(h.FormikProvider,{value:w,children:(0,e.jsxs)(h.Form,{onSubmit:w.handleSubmit,children:[(0,e.jsx)(M.H,{navigationAction:(0,e.jsx)(M.B,{href:"/settings/review-workflows"}),primaryAction:(0,e.jsx)(F.z,{startIcon:(0,e.jsx)(Z.Z,{}),type:"submit",size:"M",disabled:!ts,isLoading:ls,children:n({id:"global.save",defaultMessage:"Save"})}),title:n({id:"Settings.review-workflows.create.page.title",defaultMessage:"Create Review Workflow"}),subtitle:n({id:"Settings.review-workflows.page.subtitle",defaultMessage:"{count, plural, one {# stage} other {# stages}}"},{count:l?.stages?.length??0})}),(0,e.jsx)(M.R,{children:(0,e.jsx)(O.k,{alignItems:"stretch",direction:"column",gap:7,children:m?(0,e.jsx)(N.a,{children:n({id:"Settings.review-workflows.page.isLoading",defaultMessage:"Workflow is loading"})}):(0,e.jsxs)(O.k,{alignItems:"stretch",direction:"column",gap:7,children:[(0,e.jsx)(o.W,{}),(0,e.jsx)(o.S,{stages:w.values?.stages})]})})})]})}),(0,e.jsx)(E.ConfirmDialog.Root,{isConfirmButtonLoading:m,isOpen:Object.keys(p).length>0,onToggleDialog:_s,onConfirm:rs,children:(0,e.jsx)(E.ConfirmDialog.Body,{children:(0,e.jsxs)(O.k,{direction:"column",gap:5,children:[p.hasReassignedContentTypes&&(0,e.jsx)(I.Z,{textAlign:"center",variant:"omega",children:n({id:"Settings.review-workflows.page.delete.confirm.contentType.body",defaultMessage:"{count} {count, plural, one {content-type} other {content-types}} {count, plural, one {is} other {are}} already mapped to {count, plural, one {another workflow} other {other workflows}}. If you save changes, {count, plural, one {this} other {these}} {count, plural, one {content-type} other {{count} content-types}} will no more be mapped to the {count, plural, one {another workflow} other {other workflows}} and all corresponding information will be removed."},{count:j.filter(t=>l.contentTypes.includes(t)).length})}),(0,e.jsx)(I.Z,{textAlign:"center",variant:"omega",children:n({id:"Settings.review-workflows.page.delete.confirm.confirm",defaultMessage:"Are you sure you want to save?"})})]})})}),(0,e.jsxs)(c.L,{isOpen:K==="workflow",onClose:()=>f(!1),children:[(0,e.jsx)(c.T,{children:n({id:"Settings.review-workflows.create.page.workflows.limit.title",defaultMessage:"You\u2019ve reached the limit of workflows in your plan"})}),(0,e.jsx)(c.B,{children:n({id:"Settings.review-workflows.create.page.workflows.limit.body",defaultMessage:"Delete a workflow or contact Sales to enable more workflows."})})]}),(0,e.jsxs)(c.L,{isOpen:K==="stage",onClose:()=>f(!1),children:[(0,e.jsx)(c.T,{children:n({id:"Settings.review-workflows.create.page.stages.limit.title",defaultMessage:"You have reached the limit of stages for this workflow in your plan"})}),(0,e.jsx)(c.B,{children:n({id:"Settings.review-workflows.create.page.stages.limit.body",defaultMessage:"Try deleting some stages or contact Sales to enable more stages."})})]})]})}function b(){const n=(0,d.useSelector)(k.s);return(0,e.jsx)(E.CheckPagePermissions,{permissions:n.settings["review-workflows"].create,children:(0,e.jsx)(X,{})})}}}]);
